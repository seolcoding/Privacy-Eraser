name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2.1.0)'
        required: true
        type: string
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~\.local\bin
          key: ${{ runner.os }}-uv-0.9.5

      - name: Install UV
        shell: pwsh
        run: |
          if (-not (Test-Path "$HOME\.local\bin\uv.exe")) {
            iwr https://astral.sh/uv/install.ps1 -UseBasicParsing | iex
          }
          echo "$HOME\.local\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Cache uv packages
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\uv\cache
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml') }}

      - name: Cache Flutter SDK
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\flet\bin\flutter
          key: ${{ runner.os }}-flutter-0.28.3

      - name: Build with release_flutter.bat logic
        shell: cmd
        run: |
          REM CRITICAL: Set UTF-8 encoding to fix Rich library unicode errors
          chcp 65001 >nul
          set PYTHONIOENCODING=utf-8
          set PYTHONUTF8=1
          
          echo ============================================
          echo Step 1: Installing dependencies
          echo ============================================
          uv sync --all-extras
          if %errorlevel% neq 0 exit /b 1
          echo [OK] Dependencies installed
          
          echo.
          echo ============================================
          echo Step 2: Building with Flet
          echo ============================================
          
          REM Verify src/ is clean
          if exist "src\.venv" (
            echo [ERROR] .venv found in src/
            exit /b 1
          )
          echo [OK] src/ is clean
          
          REM Clean previous builds
          if exist "build\windows" rmdir /s /q "build\windows"
          if exist "src\build\windows" rmdir /s /q "src\build\windows"
          
          REM Build (EXACT same as release_flutter.bat line 134)
          cd src
          uv run flet build windows --exclude ".venv" --exclude "venv" --exclude "__pycache__" --exclude "tests"
          if %errorlevel% neq 0 (
            cd ..
            exit /b 1
          )
          
          REM Move build output (EXACT same as release_flutter.bat line 144-146)
          if exist "build\windows" (
            move "build\windows" "..\build\windows" >nul
          )
          cd ..
          
          REM Verify build exists
          if not exist "build\windows" (
            echo [ERROR] Build failed!
            exit /b 1
          )
          echo [OK] Build successful at build\windows

      - name: Remove app.zip (1GB+ bloat)
        shell: pwsh
        run: |
          Write-Host "============================================"
          Write-Host "Removing app.zip"
          Write-Host "============================================"
          
          $appZip = "build\windows\data\flutter_assets\app.zip"
          
          if (Test-Path $appZip) {
            $sizeMB = (Get-Item $appZip).Length / 1MB
            Write-Host "app.zip size: $([math]::Round($sizeMB, 2)) MB"
            
            Remove-Item $appZip -Force
            Write-Host "[OK] app.zip removed (saved $([math]::Round($sizeMB, 2)) MB)"
          } else {
            Write-Host "[INFO] app.zip not found (Flet 0.28.0+ may use unpacked)"
          }
          
          $finalMB = (Get-ChildItem "build\windows" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "[OK] Build size after cleanup: $([math]::Round($finalMB, 2)) MB"

      - name: Get version
        id: version
        shell: pwsh
        run: |
          if ($env:GITHUB_REF -match 'refs/tags/v(.*)') {
            $v = $matches[1]
          } elseif ("${{ github.event.inputs.version }}") {
            $v = "${{ github.event.inputs.version }}"
          } else {
            $v = "dev-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
          }
          echo "version=$v" >> $env:GITHUB_OUTPUT
          Write-Host "Version: $v"

      - name: Create ZIP
        id: zip
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $zipName = "PrivacyEraser-v$version-win-x64.zip"
          
          Write-Host "Creating ZIP: $zipName"
          Compress-Archive -Path "build\windows\*" -DestinationPath $zipName -Force
          
          $hash = (Get-FileHash $zipName).Hash
          "$hash  $zipName" | Out-File "$zipName.sha256" -Encoding ascii
          
          $sizeMB = (Get-Item $zipName).Length / 1MB
          Write-Host "[OK] ZIP size: $([math]::Round($sizeMB, 2)) MB"
          
          echo "name=$zipName" >> $env:GITHUB_OUTPUT
          echo "size=$([math]::Round($sizeMB, 2))" >> $env:GITHUB_OUTPUT

      - name: Verify size
        shell: pwsh
        run: |
          $sizeMB = ${{ steps.zip.outputs.size }}
          
          Write-Host "============================================"
          Write-Host "Size: $sizeMB MB (max: 200 MB)"
          Write-Host "============================================"
          
          if ($sizeMB -gt 200) {
            Write-Error "Too large! ($sizeMB MB)"
            exit 1
          }
          Write-Host "[OK] Size acceptable"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PrivacyEraser-Windows-v${{ steps.version.outputs.version }}
          path: |
            PrivacyEraser-v${{ steps.version.outputs.version }}-win-x64.zip
            PrivacyEraser-v${{ steps.version.outputs.version }}-win-x64.zip.sha256
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            PrivacyEraser-v${{ steps.version.outputs.version }}-win-x64.zip
            PrivacyEraser-v${{ steps.version.outputs.version }}-win-x64.zip.sha256
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        shell: pwsh
        run: |
          Write-Host "============================================"
          Write-Host "BUILD COMPLETED"
          Write-Host "============================================"
          Write-Host "Version: ${{ steps.version.outputs.version }}"
          Write-Host "Package: ${{ steps.zip.outputs.name }}"
          Write-Host "Size: ${{ steps.zip.outputs.size }} MB"
          Write-Host "============================================"
